<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hedge Pensions Name & ID Matcher</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load SheetJS (xlsx) library for reading/writing Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Load Fuse.js for fuzzy matching -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-label {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: white;
        }
        .file-input-label:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        input[type="file"]:focus + label {
            outline: 2px solid #3b82f6; /* blue-500 */
            outline-offset: 2px;
        }
        .file-name-display {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563; /* gray-600 */
        }
        .file-name-display.loaded {
            color: #16a34a; /* green-600 */
        }
        /* Slider styles */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #d1d5db; /* gray-300 */
            border-radius: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6; /* blue-600 */
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]:focus::-webkit-slider-thumb {
            background: #2563eb; /* blue-700 */
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #d1d5db;
            border-radius: 5px;
        }
        input[type=range]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 0;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gray-100">
    <div class="max-w-4xl w-full bg-white p-8 sm:p-10 rounded-xl shadow-lg space-y-8">
        <div>
            <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-gray-900">
                Hedge Pensions Name & ID Matcher
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                Upload a name list and a master list to find matching IDs, even with misspellings.
            </p>
        </div>
        
        <div class="space-y-6">
            <!-- File Upload Areas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- File 1: Name List -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">1. Name List</label>
                    <input id="file-upload-names" name="file-upload-names" type="file" class="sr-only" accept=".xlsx, .xls" data-target="names">
                    <label for="file-upload-names" class="file-input-label relative block w-full rounded-lg border-2 border-dashed border-gray-300 p-6 text-center">
                        <svg class="mx-auto h-10 w-10 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A1.5 1.5 0 0 1 18 21.75H6a1.5 1.5 0 0 1-1.499-1.632Z" />
                        </svg>
                        <span class="mt-2 block text-xs text-gray-500">(First, Other, Last Name)</span>
                    </label>
                    <div id="file-name-names" class="file-name-display text-center">No file selected</div>
                </div>

                <!-- File 2: Master List -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">2. Master List (with IDs)</label>
                    <input id="file-upload-master" name="file-upload-master" type="file" class="sr-only" accept=".xlsx, .xls" data-target="master">
                    <label for="file-upload-master" class="file-input-label relative block w-full rounded-lg border-2 border-dashed border-gray-300 p-6 text-center">
                        <svg class="mx-auto h-10 w-10 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" />
                        </svg>
                        <span class="mt-2 block text-xs text-gray-500">(First, Other, Last, ID)</span>
                    </label>
                    <div id="file-name-master" class="file-name-display text-center">No file selected</div>
                </div>
            </div>

            <!-- Fuzziness Slider -->
            <div>
                <label for="fuzziness-slider" class="block text-sm font-medium text-gray-700">Match Sensitivity</label>
                <div class="flex items-center space-x-4">
                    <span class="text-xs text-gray-500">Exact (0)</span>
                    <input id="fuzziness-slider" type="range" min="0" max="50" value="30" class="w-full">
                    <span class="text-xs text-gray-500">Fuzzy (50)</span>
                </div>
                <div id="fuzziness-display" class="text-center text-sm text-gray-600 mt-1">Tolerance: 0.30</div>
            </div>

            <!-- Compare Button -->
            <div>
                <button id="compare-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Compare Files
                </button>
            </div>
            
            <!-- Message Area -->
            <div id="message-area" class="text-sm text-center"></div>

        </div>

        <!-- Results Table -->
        <div id="results-container" class="hidden">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Matched Data</h3>
                <button id="download-button" class="hidden justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Download Results
                </button>
            </div>
            <div class="mt-4 overflow-auto rounded-lg shadow" style="max-height: 400px;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Name (List)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Other (List)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Name (List)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Found ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matched Name (Master)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Match %</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const fileUploadNames = document.getElementById('file-upload-names');
        const fileUploadMaster = document.getElementById('file-upload-master');
        const fileNameNames = document.getElementById('file-name-names');
        const fileNameMaster = document.getElementById('file-name-master');
        const compareButton = document.getElementById('compare-button');
        const downloadButton = document.getElementById('download-button');
        const messageArea = document.getElementById('message-area');
        const resultsContainer = document.getElementById('results-container');
        const resultsTableBody = document.getElementById('results-table-body');
        const fuzzinessSlider = document.getElementById('fuzziness-slider');
        const fuzzinessDisplay = document.getElementById('fuzziness-display');

        let nameListData = null;
        let masterListData = null;
        let nameListHeaders = [];
        let masterListHeaders = [];
        let lastResultsData = []; // To store data for download

        fileUploadNames.addEventListener('change', (e) => handleFile(e, 'names'));
        fileUploadMaster.addEventListener('change', (e) => handleFile(e, 'master'));
        compareButton.addEventListener('click', processComparison);
        downloadButton.addEventListener('click', downloadResults);
        fuzzinessSlider.addEventListener('input', (e) => {
            fuzzinessDisplay.textContent = `Tolerance: 0.${e.target.value.padStart(2, '0')}`;
        });

        // Helper function to correctly set file data
        function setFileStore(key, value) {
            if (key === 'nameListData') {
                nameListData = value;
            } else if (key === 'masterListData') {
                masterListData = value;
            } else if (key === 'nameListHeaders') {
                nameListHeaders = value;
            } else if (key === 'masterListHeaders') {
                masterListHeaders = value;
            }
        }

        function handleFile(event, fileType) {
            const file = event.target.files[0];
            // Fix: Changed ( ) to [ ] for array destructuring
            const [fileNameDisplay, dataStoreKey, headersStoreKey] = fileType === 'names'
                ? [fileNameNames, 'nameListData', 'nameListHeaders']
                : [fileNameMaster, 'masterListData', 'masterListHeaders'];

            if (!file) {
                fileNameDisplay.textContent = 'No file selected';
                fileNameDisplay.classList.remove('loaded');
                setFileStore(dataStoreKey, null); // Use helper
                checkFilesLoaded();
                return;
            }

            fileNameDisplay.textContent = `Loading ${file.name}...`;
            fileNameDisplay.classList.remove('loaded');
            // Hide previous results when a new file is loaded
            resultsContainer.classList.add('hidden');
            downloadButton.classList.add('hidden');
            lastResultsData = [];

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: ""}); // Use defval to ensure empty cells are treated as empty strings

                    if (jsonData.length === 0) {
                        showMessage('error', `${file.name} is empty.`);
                        fileNameDisplay.textContent = 'File is empty';
                        fileNameDisplay.classList.remove('loaded');
                        setFileStore(dataStoreKey, null); // Use helper
                    } else {
                        setFileStore(dataStoreKey, jsonData); // Use helper
                        setFileStore(headersStoreKey, Object.keys(jsonData[0])); // Use helper
                        fileNameDisplay.textContent = `${file.name} loaded`;
                        fileNameDisplay.classList.add('loaded');
                        showMessage('info', `${file.name} successfully loaded.`);
                    }
                } catch (error) {
                    console.error('File processing error:', error);
                    showMessage('error', `Error processing ${file.name}.`);
                    fileNameDisplay.textContent = 'Error loading file';
                    fileNameDisplay.classList.remove('loaded');
                    setFileStore(dataStoreKey, null); // Use helper
                }
                checkFilesLoaded();
            };
            reader.readAsArrayBuffer(file);
        }

        function checkFilesLoaded() {
            if (nameListData && masterListData) {
                compareButton.disabled = false;
            } else {
                compareButton.disabled = true;
            }
        }

        /**
         * Finds the first key in an array of keys that includes a target string.
         * Case-insensitive.
         */
        function findKey(keys, target) {
            const lowerTarget = target.toLowerCase();
            // Prioritize exact match or common variations
            const aliases = {
                'first': ['first name', 'fname', 'given name', 'first'],
                'last': ['last name', 'lname', 'surname', 'last'],
                'other': ['other name', 'middle name', 'mname', 'other'],
                'id': ['id', 'employee id', 'student id', 'number']
            };

            const targetAliases = aliases[lowerTarget] || [lowerTarget];
            
            for (const alias of targetAliases) {
                const foundKey = keys.find(key => key.toLowerCase().replace(/[^a-z0-9]/g, '') === alias.replace(/[^a-z0-9]/g, ''));
                if (foundKey) return foundKey;
            }

            // Fallback to simple includes
            return keys.find(key => key.toLowerCase().includes(lowerTarget)) || null;
        }

        /**
         * Normalizes a name string for comparison.
         */
        function normalizeName(first, other, last) {
            const f = first ? first.toString().toLowerCase().trim() : '';
            const o = other ? other.toString().toLowerCase().trim() : '';
            const l = last ? last.toString().toLowerCase().trim() : '';
            // Use a separator to avoid "JohnOther" matching "Johnot Her"
            return `${f}|${o}|${l}`;
        }
        
        function processComparison() {
            if (!nameListData || !masterListData) {
                showMessage('error', 'Please upload both files before comparing.');
                return;
            }

            showMessage('info', 'Processing comparison...');
            resultsContainer.classList.add('hidden');
            downloadButton.classList.add('hidden');
            resultsTableBody.innerHTML = '';
            lastResultsData = [];

            // 1. Find column keys
            const nameKeys = {
                first: findKey(nameListHeaders, 'first'),
                other: findKey(nameListHeaders, 'other'),
                last: findKey(nameListHeaders, 'last')
            };
            const masterKeys = {
                first: findKey(masterListHeaders, 'first'),
                other: findKey(masterListHeaders, 'other'),
                last: findKey(masterListHeaders, 'last'),
                id: findKey(masterListHeaders, 'id')
            };

            // 2. Validate keys
            let error = '';
            if (!nameKeys.first || !nameKeys.last) error += 'Name list must have "First" and "Last" name columns. ';
            if (!masterKeys.first || !masterKeys.last || !masterKeys.id) error += 'Master list must have "First", "Last", and "ID" columns. ';
            
            if (!nameKeys.other) nameKeys.other = '_missing_other_key_names_'; // Use a dummy key
            if (!masterKeys.other) masterKeys.other = '_missing_other_key_master_'; // Use a dummy key

            if (error) {
                showMessage('error', error);
                return;
            }
            
            // 3. Create a searchable list from the master list for Fuse.js
            const fuseMasterList = [];
            for (const row of masterListData) {
                const first = row[masterKeys.first] || '';
                const other = row[masterKeys.other] || '';
                const last = row[masterKeys.last] || '';
                const id = row[masterKeys.id];
                if (id) {
                    fuseMasterList.push({
                        normalized: normalizeName(first, other, last),
                        id: id,
                        originalFirst: first,
                        originalOther: other,
                        originalLast: last
                    });
                }
            }

            if (fuseMasterList.length === 0) {
                showMessage('error', 'Could not build a lookup map from the master list. Check columns and data.');
                return;
            }

            // 4. Initialize Fuse.js
            const threshold = parseFloat(fuzzinessSlider.value) / 100.0;
            const options = {
                keys: ['normalized'],
                threshold: threshold,
                includeScore: true
            };
            const fuse = new Fuse(fuseMasterList, options);

            // 5. Iterate through the name list and find matches
            const results = [];
            let foundCount = 0;
            for (const row of nameListData) {
                const first = row[nameKeys.first] || '';
                const other = row[nameKeys.other] || '';
                const last = row[nameKeys.last] || '';
                
                const key = normalizeName(first, other, last);
                const searchResult = fuse.search(key);
                
                if (searchResult.length > 0) {
                    const bestMatch = searchResult[0];
                    foundCount++;
                    results.push({
                        first: first,
                        other: other,
                        last: last,
                        foundId: bestMatch.item.id,
                        matchedName: `${bestMatch.item.originalFirst} ${bestMatch.item.originalOther} ${bestMatch.item.originalLast}`.replace(/\s+/g, ' ').trim(),
                        matchScore: (1 - bestMatch.score).toFixed(2) // Invert score (0=bad -> 1=perfect)
                    });
                } else {
                    results.push({
                        first: first,
                        other: other,
                        last: last,
                        foundId: 'Not Found',
                        matchedName: '---',
                        matchScore: '---'
                    });
                }
            }
            
            lastResultsData = results; // Save for download

            // 6. Populate the table
            populateTable(results);
            showMessage('success', `Comparison complete. Found ${foundCount} matches out of ${nameListData.length} names.`);
            resultsContainer.classList.remove('hidden');
            if (results.length > 0) {
                downloadButton.classList.remove('hidden');
            }
        }

        function populateTable(data) {
            resultsTableBody.innerHTML = ''; // Clear existing data
            let rowsHtml = '';
            data.forEach(row => {
                const idCellClass = row.foundId === 'Not Found' ? 'text-gray-400' : 'text-gray-900 font-medium';
                const matchCellClass = row.matchScore === '---' ? 'text-gray-400' : 'text-gray-700';

                rowsHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${escapeHTML(row.first.toString())}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${escapeHTML(row.other.toString())}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${escapeHTML(row.last.toString())}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${idCellClass}">${escapeHTML(row.foundId.toString())}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${matchCellClass}">${escapeHTML(row.matchedName.toString())}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${matchCellClass}">${escapeHTML(row.matchScore.toString())}</td>
                    </tr>
                `;
            });
            resultsTableBody.innerHTML = rowsHtml;
        }

        function downloadResults() {
            if (lastResultsData.length === 0) {
                showMessage('error', 'No results to download.');
                return;
            }
            
            // Create a "cleaner" array for export
            const exportData = lastResultsData.map(row => ({
                "List First Name": row.first,
                "List Other Name": row.other,
                "List Last Name": row.last,
                "Found ID": row.foundId,
                "Matched Name (from Master)": row.matchedName,
                "Match Score (1.00 = perfect)": row.matchScore
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Matched Results");
            
            // Trigger the download
            XLSX.writeFile(wb, "name_match_results.xlsx");
        }

        function showMessage(type, text) {
            messageArea.textContent = text;
            if (type === 'error') {
                messageArea.className = 'text-sm text-center text-red-600 font-medium';
            } else if (type === 'success') {
                messageArea.className = 'text-sm text-center text-green-600 font-medium';
            } else {
                messageArea.className = 'text-sm text-center text-blue-600';
            }
        }

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[m];
            });
        }

    </script>
</body>
</html>